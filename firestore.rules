
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if a user is authenticated
    function isSignedIn() {
      return request.auth != null;
    }

    // Match the top-level 'estates' collection
    match /estates/{estateId} {
      // An authenticated user can create an estate, but only if the document ID matches their own user ID.
      // This establishes them as the "owner" of that estate document and all its subcollections.
      allow create: if isSignedIn() && request.auth.uid == estateId;

      // Only the "owner" of the estate document can read, update, or delete it.
      allow get, update, delete: if isSignedIn() && request.auth.uid == estateId;
      
      // Explicitly deny anyone from listing all estates in the entire database for security.
      allow list: if false;

      // This is the master rule for ALL subcollections within an estate.
      // It uses a recursive wildcard `{docId=**}` to match any document at any depth below the estate.
      // It grants full read and write access (get, list, create, update, delete)
      // only to the user whose UID matches the `estateId` from the URL path.
      // This single, simple rule correctly and securely scopes all data access to the owner of the estate.
      match /{collection}/{docId=**} {
        allow read, write: if isSignedIn() && request.auth.uid == estateId;
      }
    }
  }
}
