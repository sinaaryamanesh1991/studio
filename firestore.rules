/**
 * @file Firestore Security Rules for Sina Estate Manager.
 *
 * Core Philosophy:
 * This ruleset enforces a strict owner-only access model within each estate. Only authenticated users can access the database, and all data is scoped to a specific estate. Every collection within an estate is secured to ensure that only members or authorized personnel of that estate can read or modify its data. Authorization is performed by requiring that the 'estateId' field within each document matches the {estateId} parameter in the path.
 *
 * Data Structure:
 * The database is structured hierarchically under the /estates/{estateId} path. Each estate has its own collections for personnel, residents, board members, villas, financial transactions, documents, payroll information, and attendance records.
 *
 * Key Security Decisions:
 * - All data access requires authentication (`isSignedIn()`).
 * - All collections are estate-scoped and enforce that the document's 'estateId' matches the path.
 * - No listing of Estates is allowed to prevent unauthorized enumeration.
 * - Strong validation on create/update operations to prevent cross-estate data manipulation.
 *
 * Denormalization for Authorization:
 * To avoid complex queries and ensure authorization independence, each document in the subcollections (personnel, residents, etc.) includes a denormalized 'estateId' field. This allows direct validation against the path without needing additional reads.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the user is signed in.
     * @returns {boolean} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the incoming data's 'estateId' matches the 'estateId' in the path.
     * @param {string} estateId - The estate ID from the path.
     * @returns {boolean} True if the 'estateId' values match, false otherwise.
     */
    function isCorrectEstate(estateId) {
      return request.resource.data.estateId == estateId;
    }

    /**
     * @description Validates that the 'estateId' field cannot be changed during an update.
     * @returns {boolean} True if the 'estateId' field remains the same, false otherwise.
     */
    function estateIdIsImmutable() {
        return request.resource.data.estateId == resource.data.estateId;
    }

    /**
     * @description
     * This rule applies to the root estates collection.
     * It only allows creation of an estate if the authenticated user's UID matches the estateId,
     * effectively making the creator the owner. Reads of single documents are allowed only for the owner.
     * Listing is disallowed for security.
     */
    match /estates/{estateId} {
      allow get: if isSignedIn() && request.auth.uid == estateId;
      allow list: if false;
      allow create: if isSignedIn() && request.auth.uid == estateId;
      allow update: if isSignedIn() && request.auth.uid == estateId;
      allow delete: if isSignedIn() && request.auth.uid == estateId;
    }

    /**
     * @description
     * This rule applies to all subcollections within an estate.
     * It allows list/read/write operations only for the user whose UID matches the estateId.
     */
    match /estates/{estateId}/{collection}/{docId} {
        allow read, write: if isSignedIn() && request.auth.uid == estateId;
    }
  }
}
